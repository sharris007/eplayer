this.JSON||(this.JSON={}),function(){"use strict";function f(a){return a<10?"0"+a:a}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,g,h=gap,i=b[a];switch(i&&"object"==typeof i&&"function"==typeof i.toJSON&&(i=i.toJSON(a)),"function"==typeof rep&&(i=rep.call(b,a,i)),typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";if(gap+=indent,g=[],"[object Array]"===Object.prototype.toString.apply(i)){for(f=i.length,c=0;c<f;c+=1)g[c]=str(c,i)||"null";return e=0===g.length?"[]":gap?"[\n"+gap+g.join(",\n"+gap)+"\n"+h+"]":"["+g.join(",")+"]",gap=h,e}if(rep&&"object"==typeof rep)for(f=rep.length,c=0;c<f;c+=1)d=rep[c],"string"==typeof d&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));return e=0===g.length?"{}":gap?"{\n"+gap+g.join(",\n"+gap)+"\n"+h+"}":"{"+g.join(",")+"}",gap=h,e}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(a){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(a,b,c){var d;if(gap="",indent="","number"==typeof c)for(d=0;d<c;d+=1)indent+=" ";else"string"==typeof c&&(indent=c);if(rep=b,b&&"function"!=typeof b&&("object"!=typeof b||"number"!=typeof b.length))throw new Error("JSON.stringify");return str("",{"":a})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&"object"==typeof e)for(c in e)Object.hasOwnProperty.call(e,c)&&(d=walk(e,c),void 0!==d?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}();var $,Util,gettext,_gettext,_ref,_t;gettext=null,"undefined"!=typeof Gettext&&null!==Gettext?(_gettext=new Gettext({domain:"annotator"}),gettext=function(a){return _gettext.gettext(a)}):gettext=function(a){return a},_t=function(a){return gettext(a)},("undefined"!=typeof jQuery&&null!==jQuery&&null!=(_ref=jQuery.fn)?_ref.jquery:void 0)||console.error(_t("Annotator requires jQuery: have you included lib/vendor/jquery.js?")),JSON&&JSON.parse&&JSON.stringify||console.error(_t("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?")),$=jQuery,Util={},Util.flatten=function(a){var b;return(b=function(a){var c,d,e,f;for(d=[],e=0,f=a.length;e<f;e++)c=a[e],d=d.concat(c&&$.isArray(c)?b(c):c);return d})(a)},Util.contains=function(a,b){var c;for(c=b;null!=c;){if(c===a)return!0;c=c.parentNode}return!1},Util.getTextNodes=function(a){var b;return b=function(a){var c;if(a&&a.nodeType!==Node.TEXT_NODE){if(c=[],a.nodeType!==Node.COMMENT_NODE)for(a=a.lastChild;a;)c.push(b(a)),a=a.previousSibling;return c.reverse()}return a},a.map(function(){return Util.flatten(b(this))})},Util.getLastTextNodeUpTo=function(a){var b;switch(a.nodeType){case Node.TEXT_NODE:return a;case Node.ELEMENT_NODE:if(null!=a.lastChild&&(b=Util.getLastTextNodeUpTo(a.lastChild),null!=b))return b}return a=a.previousSibling,null!=a?Util.getLastTextNodeUpTo(a):null},Util.getFirstTextNodeNotBefore=function(a){var b;switch(a.nodeType){case Node.TEXT_NODE:return a;case Node.ELEMENT_NODE:if(null!=a.firstChild&&(b=Util.getFirstTextNodeNotBefore(a.firstChild),null!=b))return b}return a=a.nextSibling,null!=a?Util.getFirstTextNodeNotBefore(a):null},Util.readRangeViaSelection=function(a){var b;return b=Util.getGlobal().getSelection(),b.removeAllRanges(),b.addRange(a.toRange()),b.toString()},Util.xpathFromNode=function(a,b){var c,d;try{d=simpleXPathJQuery.call(a,b)}catch(e){c=e,console.log("jQuery-based XPath construction failed! Falling back to manual."),d=simpleXPathPure.call(a,b)}return d},Util.nodeFromXPath=function(a,b){var c,d,e,f,g,h,i,j;for(g=a.substring(1).split("/"),e=b,h=0,i=g.length;h<i;h++)f=g[h],j=f.split("["),d=j[0],c=j[1],c=null!=c?parseInt((null!=c?c.split("]"):void 0)[0]):1,e=findChild(e,d.toLowerCase(),c);return e},Util.escape=function(a){return a.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},Util.uuid=function(){var a;return a=0,function(){return a++}}(),Util.getGlobal=function(){return function(){return this}()},Util.maxZIndex=function(a){var b,c;return b=function(){var b,d,e;for(e=[],b=0,d=a.length;b<d;b++)c=a[b],"static"===$(c).css("position")?e.push(-1):e.push(parseFloat($(c).css("z-index"))||-1);return e}(),Math.max.apply(Math,b)},Util.mousePosition=function(a,b){var c,d;return"absolute"!==(d=$(b).css("position"))&&"fixed"!==d&&"relative"!==d&&(b=$(b).offsetParent()[0]),c=$(b).offset(),{top:a.pageY-c.top,left:a.pageX-c.left}},Util.preventEventDefault=function(a){return null!=a&&"function"==typeof a.preventDefault?a.preventDefault():void 0};var fn,functions,_i,_j,_len,_len1,__slice=[].slice;if(functions=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"],"undefined"!=typeof console&&null!==console)for(null==console.group&&(console.group=function(a){return console.log("GROUP: ",a)}),null==console.groupCollapsed&&(console.groupCollapsed=console.group),_i=0,_len=functions.length;_i<_len;_i++)fn=functions[_i],null==console[fn]&&(console[fn]=function(){return console.log(_t("Not implemented:")+(" console."+name))});else{for(this.console={},_j=0,_len1=functions.length;_j<_len1;_j++)fn=functions[_j],this.console[fn]=function(){};this.console.error=function(){var a;return a=1<=arguments.length?__slice.call(arguments,0):[],alert("ERROR: "+a.join(", "))},this.console.warn=function(){var a;return a=1<=arguments.length?__slice.call(arguments,0):[],alert("WARNING: "+a.join(", "))}}var Delegator,__slice=[].slice,__hasProp={}.hasOwnProperty;Delegator=function(){function a(a,b){this.options=$.extend(!0,{},this.options,b),this.element=$(a),this._closures={},this.on=this.subscribe,this.addEvents()}return a.prototype.events={},a.prototype.options={},a.prototype.element=null,a.prototype.destroy=function(){return this.removeEvents()},a.prototype.addEvents=function(){var b,c,d,e,f;for(e=a._parseEvents(this.events),f=[],c=0,d=e.length;c<d;c++)b=e[c],f.push(this._addEvent(b.selector,b.event,b.functionName));return f},a.prototype.removeEvents=function(){var b,c,d,e,f;for(e=a._parseEvents(this.events),f=[],c=0,d=e.length;c<d;c++)b=e[c],f.push(this._removeEvent(b.selector,b.event,b.functionName));return f},a.prototype._addEvent=function(b,c,d){var e;return e=function(a){return function(){return a[d].apply(a,arguments)}}(this),""===b&&a._isCustomEvent(c)?this.subscribe(c,e):this.element.delegate(b,c,e),this._closures[""+b+"/"+c+"/"+d]=e,this},a.prototype._removeEvent=function(b,c,d){var e;return e=this._closures[""+b+"/"+c+"/"+d],""===b&&a._isCustomEvent(c)?this.unsubscribe(c,e):this.element.undelegate(b,c,e),delete this._closures[""+b+"/"+c+"/"+d],this},a.prototype.publish=function(){return this.element.triggerHandler.apply(this.element,arguments),this},a.prototype.subscribe=function(a,b){var c;return c=function(){return b.apply(this,[].slice.call(arguments,1))},c.guid=b.guid=$.guid+=1,this.element.bind(a,c),this},a.prototype.unsubscribe=function(){return this.element.unbind.apply(this.element,arguments),this},a}(),Delegator._parseEvents=function(a){var b,c,d,e,f,g,h;c=[];for(e in a)d=a[e],h=e.split(" "),f=2<=h.length?__slice.call(h,0,g=h.length-1):(g=0,[]),b=h[g++],c.push({selector:f.join(" "),event:b,functionName:d});return c},Delegator.natives=function(){var a,b,c;return b=function(){var b,d;b=jQuery.event.special,d=[];for(a in b)__hasProp.call(b,a)&&(c=b[a],d.push(a));return d}(),"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(b)}(),Delegator._isCustomEvent=function(a){return a=a.split(".")[0],$.inArray(a,Delegator.natives)===-1};var Range,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Range={},Range.sniff=function(a){return null!=a.commonAncestorContainer?new Range.BrowserRange(a):"string"==typeof a.start?new Range.SerializedRange(a):a.start&&"object"==typeof a.start?new Range.NormalizedRange(a):(console.error(_t("Could not sniff range type")),!1)},Range.nodeFromXPath=function(a,b){var c,d,e,f,g;return null==b&&(b=document),d=function(a,c){var d;null==c&&(c=null);try{return document.evaluate("."+a,b,c,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(c){return d=c,console.log("XPath evaluation failed."),console.log("Trying fallback..."),Util.nodeFromXPath(a,b)}},$.isXMLDoc(document.documentElement)?(c=document.createNSResolver(null===document.ownerDocument?document.documentElement:document.ownerDocument.documentElement),f=d(a,c),f||(a=function(){var b,c,d,e;for(d=a.split("/"),e=[],b=0,c=d.length;b<c;b++)g=d[b],g&&g.indexOf(":")===-1?e.push(g.replace(/^([a-z]+)/,"xhtml:$1")):e.push(g);return e}().join("/"),e=document.lookupNamespaceURI(null),c=function(a){return"xhtml"===a?e:document.documentElement.getAttribute("xmlns:"+a)},f=d(a,c)),f):d(a)},Range.RangeError=function(a){function b(a,c,d){this.type=a,this.message=c,this.parent=null!=d?d:null,b.__super__.constructor.call(this,this.message)}return __extends(b,a),b}(Error),Range.BrowserRange=function(){function a(a){this.commonAncestorContainer=a.commonAncestorContainer,this.startContainer=a.startContainer,this.startOffset=a.startOffset,this.endContainer=a.endContainer,this.endOffset=a.endOffset}return a.prototype.normalize=function(a){var b,c,d,e;if(this.tainted)return console.error(_t("You may only call normalize() once on a BrowserRange!")),!1;if(this.tainted=!0,e={},this.startContainer.nodeType===Node.ELEMENT_NODE?(e.start=Util.getFirstTextNodeNotBefore(this.startContainer.childNodes[this.startOffset]),e.startOffset=0):(e.start=this.startContainer,e.startOffset=this.startOffset),this.endContainer.nodeType===Node.ELEMENT_NODE){if(c=this.endContainer.childNodes[this.endOffset],null!=c){for(b=c;null!=b&&b.nodeType!==Node.TEXT_NODE;)b=b.firstChild;null!=b&&(e.end=b,e.endOffset=0)}null==e.end&&(c=this.endOffset?this.endContainer.childNodes[this.endOffset-1]:this.endContainer.previousSibling,e.end=Util.getLastTextNodeUpTo(c),e.endOffset=e.end.nodeValue.length)}else e.end=this.endContainer,e.endOffset=this.endOffset;for(d={},e.startOffset>0?e.start.nodeValue.length>e.startOffset?d.start=e.start.splitText(e.startOffset):d.start=e.start.nextSibling:d.start=e.start,e.start===e.end?(d.start.nodeValue.length>e.endOffset-e.startOffset&&d.start.splitText(e.endOffset-e.startOffset),d.end=d.start):(e.end.nodeValue.length>e.endOffset&&e.end.splitText(e.endOffset),d.end=e.end),d.commonAncestor=this.commonAncestorContainer;d.commonAncestor.nodeType!==Node.ELEMENT_NODE;)d.commonAncestor=d.commonAncestor.parentNode;return new Range.NormalizedRange(d)},a.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)},a}(),Range.NormalizedRange=function(){function a(a){this.commonAncestor=a.commonAncestor,this.start=a.start,this.end=a.end}return a.prototype.normalize=function(a){return this},a.prototype.limit=function(a){var b,c,d,e,f,g;if(b=$.grep(this.textNodes(),function(b){return b.parentNode===a||$.contains(a,b.parentNode)}),!b.length)return null;for(this.start=b[0],this.end=b[b.length-1],d=$(this.start).parents(),g=$(this.end).parents(),e=0,f=g.length;e<f;e++)if(c=g[e],d.index(c)!==-1){this.commonAncestor=c;break}return this},a.prototype.serialize=function(a,b){var c,d,e;return d=function(c,d){var e,f,g,h,i,j,k,l;for(h=b?$(c).parents(":not("+b+")").eq(0):$(c).parent(),j=Util.xpathFromNode(h,a)[0],i=Util.getTextNodes(h),f=i.slice(0,i.index(c)),g=0,k=0,l=f.length;k<l;k++)e=f[k],g+=e.nodeValue.length;return d?[j,g+c.nodeValue.length]:[j,g]},e=d(this.start),c=d(this.end,!0),new Range.SerializedRange({start:e[0],end:c[0],startOffset:e[1],endOffset:c[1]})},a.prototype.text=function(){var a;return function(){var b,c,d,e;for(d=this.textNodes(),e=[],b=0,c=d.length;b<c;b++)a=d[b],e.push(a.nodeValue);return e}.call(this).join("")},a.prototype.textNodes=function(){var a,b,c,d;return c=Util.getTextNodes($(this.commonAncestor)),d=[c.index(this.start),c.index(this.end)],b=d[0],a=d[1],$.makeArray(c.slice(b,+a+1||9e9))},a.prototype.toRange=function(){var a;return a=document.createRange(),a.setStartBefore(this.start),a.setEndAfter(this.end),a},a}(),Range.SerializedRange=function(){function a(a){this.start=a.start,this.startOffset=a.startOffset,this.end=a.end,this.endOffset=a.endOffset}return a.prototype.normalize=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o;for(g={},n=["start","end"],j=0,l=n.length;j<l;j++){f=n[j];try{e=Range.nodeFromXPath(this[f],a)}catch(a){throw c=a,new Range.RangeError(f,"Error while finding "+f+" node: "+this[f]+": "+c,c)}if(!e)throw new Range.RangeError(f,"Couldn't find "+f+" node: "+this[f]);for(d=0,h=this[f+"Offset"],"end"===f&&h--,o=Util.getTextNodes($(e)),k=0,m=o.length;k<m;k++){if(i=o[k],d+i.nodeValue.length>h){g[f+"Container"]=i,g[f+"Offset"]=this[f+"Offset"]-d;break}d+=i.nodeValue.length}if(null==g[f+"Offset"])throw new Range.RangeError(""+f+"offset","Couldn't find offset "+this[f+"Offset"]+" in element "+this[f])}return b=null==document.compareDocumentPosition?function(a,b){return a.contains(b)}:function(a,b){return 16&a.compareDocumentPosition(b)},$(g.startContainer).parents().each(function(){if(b(this,g.endContainer))return g.commonAncestorContainer=this,!1}),new Range.BrowserRange(g).normalize(a)},a.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)},a.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}},a}();var Annotator,g,_Annotator,_ref,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};_Annotator=this.Annotator,Annotator=function(a){function b(a,c){return this.onDeleteAnnotation=__bind(this.onDeleteAnnotation,this),this.onEditAnnotation=__bind(this.onEditAnnotation,this),this.onAdderClick=__bind(this.onAdderClick,this),this.onAdderMousedown=__bind(this.onAdderMousedown,this),this.onHighlightMouseover=__bind(this.onHighlightMouseover,this),this.checkForEndSelection=__bind(this.checkForEndSelection,this),this.checkForStartSelection=__bind(this.checkForStartSelection,this),this.clearViewerHideTimer=__bind(this.clearViewerHideTimer,this),this.startViewerHideTimer=__bind(this.startViewerHideTimer,this),this.showViewer=__bind(this.showViewer,this),this.onEditorSubmit=__bind(this.onEditorSubmit,this),this.onEditorHide=__bind(this.onEditorHide,this),this.showEditor=__bind(this.showEditor,this),b.__super__.constructor.apply(this,arguments),this.plugins={},b.supported()?(this.options.readOnly||this._setupDocumentEvents(),this._setupWrapper()._setupViewer()._setupEditor(),this._setupDynamicStyle(),this.adder=$(this.html.adder).appendTo(this.wrapper).hide(),void b._instances.push(this)):this}return __extends(b,a),b.prototype.events={".annotator-adder click":"onAdderClick",".annotator-adder mousedown":"onAdderMousedown"},b.prototype.html={adder:'<div class="annotator-adder"><button>'+_t("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'},b.prototype.options={readOnly:!1},b.prototype.plugins={},b.prototype.editor=null,b.prototype.viewer=null,b.prototype.selectedRanges=null,b.prototype.mouseIsDown=!1,b.prototype.ignoreMouseup=!1,b.prototype.viewerHideTimer=null,b.prototype._setupWrapper=function(){return this.wrapper=$(this.html.wrapper),this.element.find("script").remove(),this.element.wrapInner(this.wrapper),this.wrapper=this.element.find(".annotator-wrapper"),this},b.prototype._setupViewer=function(){return this.viewer=new b.Viewer({readOnly:this.options.readOnly}),this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(a){return function(b,c){return c.text?$(b).html(Util.escape(c.text)):$(b).html("<i>"+_t("No Comment")+"</i>"),a.publish("annotationViewerTextField",[b,c])}}(this)}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer}),this},b.prototype._setupEditor=function(){return this.editor=new b.Editor,this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:_t("Comments")+"…",load:function(a,b){return $(a).find("textarea").val(b.text||"")},submit:function(a,b){return b.text=$(a).find("textarea").val()}}),this.editor.element.appendTo(this.wrapper),this},b.prototype._setupDocumentEvents=function(){return $(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),this},b.prototype._setupDynamicStyle=function(){var a,b,c,d;return c=$("#annotator-dynamic-style"),c.length||(c=$('<style id="annotator-dynamic-style"></style>').appendTo(document.head)),b="*"+function(){var a,b,c,e;for(c=["adder","outer","notice","filter"],e=[],a=0,b=c.length;a<b;a++)d=c[a],e.push(":not(.annotator-"+d+")");return e}().join(""),a=Util.maxZIndex($(document.body).find(b)),a=Math.max(a,1e3),c.text([".annotator-adder, .annotator-outer, .annotator-notice {","  z-index: "+(a+20)+";","}",".annotator-filter {","  z-index: "+(a+10)+";","}"].join("\n")),this},b.prototype.destroy=function(){var a,c,d,e,f;b.__super__.destroy.apply(this,arguments),$(document).unbind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),$("#annotator-dynamic-style").remove(),this.adder.remove(),this.viewer.destroy(),this.editor.destroy(),this.wrapper.find(".annotator-hl").each(function(){return $(this).contents().insertBefore(this),$(this).remove()}),this.wrapper.contents().insertBefore(this.wrapper),this.wrapper.remove(),this.element.data("annotator",null),f=this.plugins;for(c in f)d=f[c],"function"==typeof(e=this.plugins[c]).destroy&&e.destroy();if(a=b._instances.indexOf(this),a!==-1)return b._instances.splice(a,1)},b.prototype.getSelectedRanges=function(){var a,b,c,d,e,f,g,h,i;for(g=Util.getGlobal().getSelection(),e=[],f=[],g.isCollapsed||(e=function(){var e,h,i;for(i=[],b=e=0,h=g.rangeCount;0<=h?e<h:e>h;b=0<=h?++e:--e)d=g.getRangeAt(b),a=new Range.BrowserRange(d),c=a.normalize().limit(this.wrapper[0]),null===c&&f.push(d),i.push(c);return i}.call(this),g.removeAllRanges()),h=0,i=f.length;h<i;h++)d=f[h],g.addRange(d);return $.grep(e,function(a){return a&&g.addRange(a.toRange()),a})},b.prototype.createAnnotation=function(){var a;return a={},this.publish("beforeAnnotationCreated",[a]),a},b.prototype.setupAnnotation=function(a){var b,c,d,e,f,g,h,i,j,k;for(f=this.wrapper[0],a.ranges||(a.ranges=this.selectedRanges),d=[],k=a.ranges,g=0,i=k.length;g<i;g++){e=k[g];try{d.push(Range.sniff(e).normalize(f))}catch(c){if(b=c,!(b instanceof Range.RangeError))throw b;this.publish("rangeNormalizeFail",[a,e,b])}}for(a.quote=[],a.ranges=[],a.highlights=[],h=0,j=d.length;h<j;h++)c=d[h],c.color=a.color,a.quote.push($.trim(c.text())),a.ranges.push(c.serialize(this.wrapper[0],".annotator-hl")),$.merge(a.highlights,this.highlightRange(c));return a.quote=a.quote.join(" / "),$(a.highlights).data("annotation",a),$(a.highlights).attr("data-annotation-id",a.id),a},b.prototype.updateAnnotation=function(a){return this.publish("beforeAnnotationUpdated",[a]),$(a.highlights).attr("data-annotation-id",a.id),this.publish("annotationUpdated",[a]),a},b.prototype.deleteAnnotation=function(a){var b,c,d,e,f;if(null!=a.highlights)for(f=a.highlights,d=0,e=f.length;d<e;d++)c=f[d],null!=c.parentNode&&(b=c.childNodes[0],$(c).replaceWith(c.childNodes));return this.publish("annotationDeleted",[a]),a},b.prototype.loadAnnotations=function(a){var b,c;return null==a&&(a=[]),c=function(a){return function(d){var e,f,g,h;for(null==d&&(d=[]),f=d.splice(0,10),g=0,h=f.length;g<h;g++)e=f[g],a.setupAnnotation(e);return d.length>0?setTimeout(function(){return c(d)},10):a.publish("annotationsLoaded",[b])}}(this),b=a.slice(),c(a),this},b.prototype.dumpAnnotations=function(){return this.plugins.Store?this.plugins.Store.dumpAnnotations():(console.warn(_t("Can't dump annotations without Store plugin.")),!1)},b.prototype.highlightRange=function(a,b){var c,d,e,f,g,h,i;for(null==b&&(b="annotator-hl"),e=/^\s*$/,a.color=a.color||"#FCF37F",c=$("<span class='"+b+"' style=background:"+a.color+"></span>"),h=a.textNodes(),i=[],f=0,g=h.length;f<g;f++)d=h[f],e.test(d.nodeValue)||i.push($(d).wrapAll(c).parent().show()[0]);return i},b.prototype.highlightRanges=function(a,b){var c,d,e,f;for(null==b&&(b="annotator-hl"),c=[],e=0,f=a.length;e<f;e++)d=a[e],$.merge(c,this.highlightRange(d,b));return c},b.prototype.addPlugin=function(a,c){var d,e;return this.plugins[a]?console.error(_t("You cannot have more than one instance of any plugin.")):(d=b.Plugin[a],"function"==typeof d?(this.plugins[a]=new d(this.element[0],c),this.plugins[a].annotator=this,"function"==typeof(e=this.plugins[a]).pluginInit&&e.pluginInit()):console.error(_t("Could not load ")+a+_t(" plugin. Have you included the appropriate <script> tag?"))),this},b.prototype.showEditor=function(a,b){return this.editor.element.css(b),this.editor.load(a),this.publish("annotationEditorShown",[this.editor,a]),this},b.prototype.onEditorHide=function(){return this.publish("annotationEditorHidden",[this.editor]),this.ignoreMouseup=!1},b.prototype.onEditorSubmit=function(a){return this.publish("annotationEditorSubmit",[this.editor,a])},b.prototype.showViewer=function(a,b){return this.viewer.element.css(b),this.viewer.load(a),this.publish("annotationViewerShown",[this.viewer,a])},b.prototype.startViewerHideTimer=function(){if(!this.viewerHideTimer)return this.viewerHideTimer=setTimeout(this.viewer.hide,250)},b.prototype.clearViewerHideTimer=function(){return clearTimeout(this.viewerHideTimer),this.viewerHideTimer=!1},b.prototype.checkForStartSelection=function(a){return a&&this.isAnnotator(a.target)||this.startViewerHideTimer(),this.mouseIsDown=!0},b.prototype.checkForEndSelection=function(a){var b,c,d,e,f;if(this.mouseIsDown=!1,!this.ignoreMouseup){for(this.selectedRanges=this.getSelectedRanges(),f=this.selectedRanges,d=0,e=f.length;d<e;d++)if(c=f[d],b=c.commonAncestor,this.isAnnotator(b))return;return a&&this.selectedRanges.length?(this.onAdderClick(a),this.onAdderMousedown(),this.adder):this.adder.hide()}},b.prototype.isAnnotator=function(a){return!!$(a).parents().addBack().filter("[class^=annotator-]").not("[class^=annotator-hl]").not(this.wrapper).length},b.prototype.onHighlightMouseover=function(a){var b;return this.clearViewerHideTimer(),!this.mouseIsDown&&(this.viewer.isShown()&&this.viewer.hide(),b=$(a.target).parents(".annotator-hl").addBack().map(function(){return $(this).data("annotation")}).toArray(),this.showViewer(b,Util.mousePosition(a,this.wrapper[0])))},b.prototype.onAdderMousedown=function(a){return null!=a&&a.preventDefault(),this.ignoreMouseup=!0},b.prototype.clearTextSelection=function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},b.prototype.onAdderClick=function(a){var b,c,d,e,f;return null!=a&&a.preventDefault(),e=Util.mousePosition(a,this.wrapper[0]),this.adder.hide(),b=this.setupAnnotation(this.createAnnotation()),this.clearTextSelection(),$(b.highlights).addClass("annotator-hl-temporary"),f=function(a){return function(){return d(),$(b.highlights).removeClass("annotator-hl-temporary"),a.publish("annotationCreated",[b])}}(this),c=function(a){return function(){return d(),a.deleteAnnotation(b)}}(this),d=function(a){return function(){return a.unsubscribe("annotationEditorHidden",c),a.unsubscribe("annotationEditorSubmit",f)}}(this),this.subscribe("annotationEditorHidden",c),this.subscribe("annotationEditorSubmit",f),this.showEditor(b,e)},b.prototype.onEditAnnotation=function(a){var b,c,d;return c=this.viewer.element.position(),d=function(c){return function(){return b(),c.updateAnnotation(a)}}(this),b=function(a){return function(){return a.unsubscribe("annotationEditorHidden",b),a.unsubscribe("annotationEditorSubmit",d)}}(this),this.subscribe("annotationEditorHidden",b),this.subscribe("annotationEditorSubmit",d),this.viewer.hide(),this.showEditor(a,c)},b.prototype.onDeleteAnnotation=function(a){return this.viewer.hide(),this.deleteAnnotation(a)},b}(Delegator),Annotator.Plugin=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.pluginInit=function(){},b}(Delegator),g=Util.getGlobal(),null==(null!=(_ref=g.document)?_ref.evaluate:void 0)&&$.getScript("http://assets.annotateit.org/vendor/xpath.min.js"),null==g.getSelection&&$.getScript("http://assets.annotateit.org/vendor/ierange.min.js"),null==g.JSON&&$.getScript("http://assets.annotateit.org/vendor/json2.min.js"),null==g.Node&&(g.Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}),Annotator.$=$,Annotator.Delegator=Delegator,Annotator.Range=Range,Annotator.Util=Util,Annotator._instances=[],Annotator._t=_t,Annotator.supported=function(){return function(){return!!this.getSelection}()},Annotator.noConflict=function(){return Util.getGlobal().Annotator=_Annotator,this},$.fn.annotator=function(a){var b;return b=Array.prototype.slice.call(arguments,1),this.each(function(){var c;return c=$.data(this,"annotator"),"destroy"===a?($.removeData(this,"annotator"),null!=c?c.destroy(b):void 0):c?a&&c[a].apply(c,b):(c=new Annotator(this,a),$.data(this,"annotator",c))})},this.Annotator=Annotator;var __hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Widget=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments),this.classes=$.extend({},Annotator.Widget.prototype.classes,this.classes)}return __extends(b,a),b.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}},b.prototype.destroy=function(){return this.removeEvents(),this.element.remove()},b.prototype.checkOrientation=function(){var a,b,c,d,e;return this.resetOrientation(),e=$(Annotator.Util.getGlobal()),d=this.element.children(":first"),b=d.offset(),c={top:e.scrollTop(),right:e.width()+e.scrollLeft()},a={top:b.top,right:b.left+d.width()},a.top-c.top<0&&this.invertY(),a.right-c.right>0&&this.invertX(),this},b.prototype.resetOrientation=function(){return this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y),this},b.prototype.invertX=function(){return this.element.addClass(this.classes.invert.x),this},b.prototype.invertY=function(){return this.element.addClass(this.classes.invert.y),this},b.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)},b.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)},b}(Delegator);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Editor=function(a){function b(a){this.onCancelButtonMouseover=__bind(this.onCancelButtonMouseover,this),this.processKeypress=__bind(this.processKeypress,this),this.submit=__bind(this.submit,this),this.load=__bind(this.load,this),this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),this.onColorChange=__bind(this.onColorChange,this),b.__super__.constructor.call(this,$(this.html)[0],a),this.fields=[],this.annotation={}}return __extends(b,a),b.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress",".annotator-color click":"onColorChange"},b.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"},b.prototype.html='<div class="annotator-outer annotator-editor">\n <form class="annotator-widget">\n    <div class="annotator-color-container"><button class="annotator-color annotator-yellow" value="#FCF37F"></button> <button class="annotator-color annotator-green" value="#55DF49"></button> <button class="annotator-color annotator-pink" value="#FC92CF"></button> </div>\n<ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+_t("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+_t("Save")+"</a>\n    </div>\n  </form>\n</div>",b.prototype.options={},b.prototype.onColorChange=function(a){a.preventDefault(),this.annotation.color=a.target.value,$(".annotator-color").removeClass("active"),$(a.target).addClass("active"),$(this.annotation.highlights).css("background",a.target.value)},b.prototype.show=function(a){return Annotator.Util.preventEventDefault(a),this.element.removeClass(this.classes.hide),this.annotation.color="",$(".annotator-color").removeClass("active"),$(".annotator-color:first").addClass("active"),this.element.find(".annotator-save").addClass(this.classes.focus),this.checkOrientation(),this.element.find(":input:first").focus(),this.setupDraggables(),this.publish("show")},b.prototype.hide=function(a){return Annotator.Util.preventEventDefault(a),this.element.addClass(this.classes.hide),this.publish("hide")},b.prototype.load=function(a){var b,c,d,e;for(this.annotation=a,this.publish("load",[this.annotation]),e=this.fields,c=0,d=e.length;c<d;c++)b=e[c],b.load(b.element,this.annotation);return this.show()},b.prototype.submit=function(a){var b,c,d,e;for(Annotator.Util.preventEventDefault(a),e=this.fields,c=0,d=e.length;c<d;c++)b=e[c],b.submit(b.element,this.annotation);return this.publish("save",[this.annotation]),this.hide()},b.prototype.addField=function(a){var b,c,d;switch(c=$.extend({id:"annotator-field-"+Annotator.Util.uuid(),type:"input",label:"",load:function(){},submit:function(){}},a),d=null,b=$('<li class="annotator-item" />'),c.element=b[0],c.type){case"textarea":d=$("<textarea />");break;case"input":case"checkbox":d=$("<input />");break;case"select":d=$("<select />")}return b.append(d),d.attr({id:c.id,placeholder:c.label
}),"checkbox"===c.type&&(d[0].type="checkbox",b.addClass("annotator-checkbox"),b.append($("<label />",{for:c.id,html:c.label}))),this.element.find("ul:first").append(b),this.fields.push(c),c.element},b.prototype.checkOrientation=function(){var a,c;return b.__super__.checkOrientation.apply(this,arguments),c=this.element.find("ul"),a=this.element.find(".annotator-controls"),this.element.hasClass(this.classes.invert.y)?a.insertAfter(c):a.is(":first-child")&&a.insertAfter(c),this},b.prototype.processKeypress=function(a){return 27===a.keyCode?this.hide():13!==a.keyCode||a.shiftKey?void 0:this.submit()},b.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)},b.prototype.setupDraggables=function(){var a,b,c,d,e,f,g,h,i,j,k;return this.element.find(".annotator-resize").remove(),c=this.element.hasClass(this.classes.invert.y)?this.element.find(".annotator-item:last"):this.element.find(".annotator-item:first"),c&&$('<span class="annotator-resize"></span>').appendTo(c),e=null,a=this.classes,d=this.element,j=null,i=d.find(".annotator-resize"),b=d.find(".annotator-controls"),k=!1,f=function(a){if(a.target===this)return e={element:this,top:a.pageY,left:a.pageX},j=d.find("textarea:first"),$(window).bind({"mouseup.annotator-editor-resize":h,"mousemove.annotator-editor-resize":g}),a.preventDefault()},h=function(){return e=null,$(window).unbind(".annotator-editor-resize")},g=function(c){return function(c){var f,g,h,l,m;if(e&&k===!1)return f={top:c.pageY-e.top,left:c.pageX-e.left},e.element===i[0]?(l=j.height(),m=j.width(),g=d.hasClass(a.invert.x)?-1:1,h=d.hasClass(a.invert.y)?1:-1,j.height(l+f.top*h),j.width(m+f.left*g),j.height()!==l&&(e.top=c.pageY),j.width()!==m&&(e.left=c.pageX)):e.element===b[0]&&(d.css({top:parseInt(d.css("top"),10)+f.top,left:parseInt(d.css("left"),10)+f.left}),e.top=c.pageY,e.left=c.pageX),k=!0,setTimeout(function(){return k=!1},1e3/60)}}(this),i.bind("mousedown",f),b.bind("mousedown",f)},b}(Annotator.Widget);var LinkParser,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Viewer=function(a){function b(a){this.onDeleteClick=__bind(this.onDeleteClick,this),this.onEditClick=__bind(this.onEditClick,this),this.load=__bind(this.load,this),this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),b.__super__.constructor.call(this,$(this.html.element)[0],a),this.item=$(this.html.item)[0],this.fields=[],this.annotations=[]}return __extends(b,a),b.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"},b.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"},b.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <a href="#" title="View as webpage" class="annotator-link">View as webpage</a>\n    <button title="Edit" class="annotator-edit">Edit</button>\n    <button title="Delete" class="annotator-delete">Delete</button>\n  </span>\n</li>'},b.prototype.options={readOnly:!1},b.prototype.show=function(a){var b;return Annotator.Util.preventEventDefault(a),b=this.element.find(".annotator-controls").addClass(this.classes.showControls),setTimeout(function(a){return function(){return b.removeClass(a.classes.showControls)}}(this),500),this.element.removeClass(this.classes.hide),this.checkOrientation().publish("show")},b.prototype.isShown=function(){return!this.element.hasClass(this.classes.hide)},b.prototype.hide=function(a){return Annotator.Util.preventEventDefault(a),this.element.addClass(this.classes.hide),this.publish("hide")},b.prototype.load=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;for(this.annotations=a||[],l=this.element.find("ul:first").empty(),q=this.annotations,m=0,o=q.length;m<o;m++)for(b=q[m],i=$(this.item).clone().appendTo(l).data("annotation",b),d=i.find(".annotator-controls"),j=d.find(".annotator-link"),f=d.find(".annotator-edit"),e=d.find(".annotator-delete"),k=new LinkParser(b.links||[]).get("alternate",{type:"text/html"}),0===k.length||null==k[0].href?j.remove():j.attr("href",k[0].href),this.options.readOnly?(f.remove(),e.remove()):c={showEdit:function(){return f.removeAttr("disabled")},hideEdit:function(){return f.attr("disabled","disabled")},showDelete:function(){return e.removeAttr("disabled")},hideDelete:function(){return e.attr("disabled","disabled")}},r=this.fields,n=0,p=r.length;n<p;n++)h=r[n],g=$(h.element).clone().appendTo(i)[0],h.load(g,b,c);return this.publish("load",[this.annotations]),this.show()},b.prototype.addField=function(a){var b;return b=$.extend({load:function(){}},a),b.element=$("<div />")[0],this.fields.push(b),b.element,this},b.prototype.onEditClick=function(a){return this.onButtonClick(a,"edit")},b.prototype.onDeleteClick=function(a){return this.onButtonClick(a,"delete")},b.prototype.onButtonClick=function(a,b){var c;return c=$(a.target).parents(".annotator-annotation"),this.publish(b,[c.data("annotation")])},b}(Annotator.Widget),LinkParser=function(){function a(a){this.data=a}return a.prototype.get=function(a,b){var c,d,e,f,g,h,i,j,k;for(null==b&&(b={}),b=$.extend({},b,{rel:a}),e=function(){var a;a=[];for(d in b)__hasProp.call(b,d)&&(g=b[d],a.push(d));return a}(),j=this.data,k=[],h=0,i=j.length;h<i;h++)c=j[h],f=e.reduce(function(a,d){return a&&c[d]===b[d]},!0),f&&k.push(c);return k},a}();var Annotator,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator=Annotator||{},Annotator.Notification=function(a){function b(a){this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),b.__super__.constructor.call(this,$(this.options.html).appendTo(document.body)[0],a)}return __extends(b,a),b.prototype.events={click:"hide"},b.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}},b.prototype.show=function(a,b){return null==b&&(b=Annotator.Notification.INFO),this.currentStatus=b,$(this.element).addClass(this.options.classes.show).addClass(this.options.classes[this.currentStatus]).html(Util.escape(a||"")),setTimeout(this.hide,5e3),this},b.prototype.hide=function(){return null==this.currentStatus&&(this.currentStatus=Annotator.Notification.INFO),$(this.element).removeClass(this.options.classes.show).removeClass(this.options.classes[this.currentStatus]),this},b}(Delegator),Annotator.Notification.INFO="info",Annotator.Notification.SUCCESS="success",Annotator.Notification.ERROR="error",$(function(){var a;return a=new Annotator.Notification,Annotator.showNotification=a.show,Annotator.hideNotification=a.hide});var findChild,getNodeName,getNodePosition,simpleXPathJQuery,simpleXPathPure;simpleXPathJQuery=function(a){var b;return b=this.map(function(){var b,c,d,e;for(d="",b=this;(null!=b?b.nodeType:void 0)===Node.ELEMENT_NODE&&b!==a;)e=b.tagName.replace(":","\\:"),c=$(b.parentNode).children(e).index(b)+1,c="["+c+"]",d="/"+b.tagName.toLowerCase()+c+d,b=b.parentNode;return d}),b.get()},simpleXPathPure=function(a){var b,c,d,e;return b=function(a){var b,c;return b=getNodeName(a),c=getNodePosition(a),""+b+"["+c+"]"},e=a,c=function(a){var c;for(c="";a!==e;){if(null==a)throw new Error("Called getPathTo on a node which was not a descendant of @rootNode. "+e);c=b(a)+"/"+c,a=a.parentNode}return c="/"+c,c=c.replace(/\/$/,"")},d=this.map(function(){var a;return a=c(this)}),d.get()},findChild=function(a,b,c){var d,e,f,g,h,i;if(!a.hasChildNodes())throw new Error("XPath error: node has no children!");for(e=a.childNodes,f=0,h=0,i=e.length;h<i;h++)if(d=e[h],g=getNodeName(d),g===b&&(f+=1,f===c))return d;throw new Error("XPath error: wanted child not found.")},getNodeName=function(a){var b;switch(b=a.nodeName.toLowerCase()){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return b}},getNodePosition=function(a){var b,c;for(b=0,c=a;c;)c.nodeName===a.nodeName&&b++,c=c.previousSibling;return b};var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};Annotator.Plugin.Store=function(a){function b(a,c){this._onError=__bind(this._onError,this),this._onLoadAnnotationsFromSearch=__bind(this._onLoadAnnotationsFromSearch,this),this._onLoadAnnotations=__bind(this._onLoadAnnotations,this),this._getAnnotations=__bind(this._getAnnotations,this),b.__super__.constructor.apply(this,arguments),this.annotations=[]}return __extends(b,a),b.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"},b.prototype.options={annotationData:{},emulateHTTP:!1,loadFromSearch:!1,prefix:"/store",urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}},b.prototype.pluginInit=function(){if(Annotator.supported())return this.annotator.plugins.Auth?this.annotator.plugins.Auth.withToken(this._getAnnotations):this._getAnnotations()},b.prototype._getAnnotations=function(){return this.options.loadFromSearch?this.loadAnnotationsFromSearch(this.options.loadFromSearch):this.loadAnnotations()},b.prototype.annotationCreated=function(a){return __indexOf.call(this.annotations,a)<0?(this.registerAnnotation(a),this._apiRequest("create",a,function(b){return function(c){return null==c.id&&console.warn(Annotator._t("Warning: No ID returned from server for annotation "),a),b.updateAnnotation(a,c)}}(this))):this.updateAnnotation(a,{})},b.prototype.annotationUpdated=function(a){if(__indexOf.call(this.annotations,a)>=0)return this._apiRequest("update",a,function(b){return function(c){return b.updateAnnotation(a,c)}}(this))},b.prototype.annotationDeleted=function(a){if(__indexOf.call(this.annotations,a)>=0)return this._apiRequest("destroy",a,function(b){return function(){return b.unregisterAnnotation(a)}}(this))},b.prototype.registerAnnotation=function(a){return this.annotations.push(a)},b.prototype.unregisterAnnotation=function(a){return this.annotations.splice(this.annotations.indexOf(a),1)},b.prototype.updateAnnotation=function(a,b){return __indexOf.call(this.annotations,a)<0?console.error(Annotator._t("Trying to update unregistered annotation!")):$.extend(a,b),$(a.highlights).data("annotation",a)},b.prototype.loadAnnotations=function(){return this._apiRequest("read",null,this._onLoadAnnotations)},b.prototype._onLoadAnnotations=function(a){var b,c,d,e,f,g,h,i,j;for(null==a&&(a=[]),d={},j=this.annotations,f=0,h=j.length;f<h;f++)b=j[f],d[b.id]=b;for(e=[],g=0,i=a.length;g<i;g++)b=a[g],d[b.id]?(c=d[b.id],this.updateAnnotation(c,b)):e.push(b);return this.annotations=this.annotations.concat(e),this.annotator.loadAnnotations(e.slice())},b.prototype.loadAnnotationsFromSearch=function(a){return this._apiRequest("search",a,this._onLoadAnnotationsFromSearch)},b.prototype._onLoadAnnotationsFromSearch=function(a){return null==a&&(a={}),this._onLoadAnnotations(a.rows||[])},b.prototype.dumpAnnotations=function(){var a,b,c,d,e;for(d=this.annotations,e=[],b=0,c=d.length;b<c;b++)a=d[b],e.push(JSON.parse(this._dataFor(a)));return e},b.prototype._apiRequest=function(a,b,c){var d,e,f,g;return d=b&&b.id,g=this._urlFor(a,d),e=this._apiRequestOptions(a,b,c),f=$.ajax(g,e),f._id=d,f._action=a,f},b.prototype._apiRequestOptions=function(a,b,c){var d,e,f;return e=this._methodFor(a),f={type:e,headers:this.element.data("annotator:headers"),dataType:"json",success:c||function(){},error:this._onError},!this.options.emulateHTTP||"PUT"!==e&&"DELETE"!==e||(f.headers=$.extend(f.headers,{"X-HTTP-Method-Override":e}),f.type="POST"),"search"===a?f=$.extend(f,{data:b}):(d=b&&this._dataFor(b),this.options.emulateJSON?(f.data={json:d},this.options.emulateHTTP&&(f.data._method=e),f):f=$.extend(f,{data:d,contentType:"application/json; charset=utf-8"}))},b.prototype._urlFor=function(a,b){var c;return c=null!=this.options.prefix?this.options.prefix:"",c+=this.options.urls[a],c=c.replace(/\/:id/,null!=b?"/"+b:""),c=c.replace(/:id/,null!=b?b:"")},b.prototype._methodFor=function(a){var b;return b={create:"POST",read:"GET",update:"PUT",destroy:"DELETE",search:"GET"},b[a]},b.prototype._dataFor=function(a){var b,c;return c=a.highlights,delete a.highlights,$.extend(a,this.options.annotationData),b=JSON.stringify(a),c&&(a.highlights=c),b},b.prototype._onError=function(a){var b,c;switch(b=a._action,c=Annotator._t("Sorry we could not ")+b+Annotator._t(" this annotation"),"search"===a._action?c=Annotator._t("Sorry we could not search the store for annotations"):"read"!==a._action||a._id||(c=Annotator._t("Sorry we could not ")+b+Annotator._t(" the annotations from the store")),a.status){case 401:c=Annotator._t("Sorry you are not allowed to ")+b+Annotator._t(" this annotation");break;case 404:c=Annotator._t("Sorry we could not connect to the annotations store");break;case 500:c=Annotator._t("Sorry something went wrong with the annotation store")}return Annotator.showNotification(c,Annotator.Notification.ERROR),console.error(Annotator._t("API request failed:")+(" '"+a.status+"'"))},b}(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Permissions=function(a){function b(a,c){this._setAuthFromToken=__bind(this._setAuthFromToken,this),this.updateViewer=__bind(this.updateViewer,this),this.updateAnnotationPermissions=__bind(this.updateAnnotationPermissions,this),this.updatePermissionsField=__bind(this.updatePermissionsField,this),this.addFieldsToAnnotation=__bind(this.addFieldsToAnnotation,this),b.__super__.constructor.apply(this,arguments),this.options.user&&(this.setUser(this.options.user),delete this.options.user)}return __extends(b,a),b.prototype.events={beforeAnnotationCreated:"addFieldsToAnnotation"},b.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,userId:function(a){return a},userString:function(a){return a},userAuthorize:function(a,b,c){var d,e,f,g;if(b.permissions){if(e=b.permissions[a]||[],0===e.length)return!0;for(f=0,g=e.length;f<g;f++)if(d=e[f],this.userId(c)===d)return!0;return!1}return!b.user||!!c&&this.userId(c)===this.userId(b.user)},user:"",permissions:{read:[],update:[],delete:[],admin:[]}},b.prototype.pluginInit=function(){var a,b;if(Annotator.supported())return b=this,a=function(a,c){return function(d,e){return b[a].call(b,c,d,e)}},!this.user&&this.annotator.plugins.Auth&&this.annotator.plugins.Auth.withToken(this._setAuthFromToken),this.options.showViewPermissionsCheckbox===!0&&this.annotator.editor.addField({type:"checkbox",label:Annotator._t("Allow anyone to <strong>view</strong> this annotation"),load:a("updatePermissionsField","read"),submit:a("updateAnnotationPermissions","read")}),this.options.showEditPermissionsCheckbox===!0&&this.annotator.editor.addField({type:"checkbox",label:Annotator._t("Allow anyone to <strong>edit</strong> this annotation"),load:a("updatePermissionsField","update"),submit:a("updateAnnotationPermissions","update")}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter?this.annotator.plugins.Filter.addFilter({label:Annotator._t("User"),property:"user",isFiltered:function(a){return function(b,c){var d,e,f,g;if(c=a.options.userString(c),!b||!c)return!1;for(g=b.split(/\s*/),e=0,f=g.length;e<f;e++)if(d=g[e],c.indexOf(d)===-1)return!1;return!0}}(this)}):void 0},b.prototype.setUser=function(a){return this.user=a},b.prototype.addFieldsToAnnotation=function(a){if(a&&(a.permissions=$.extend(!0,{},this.options.permissions),this.user))return a.user=this.user},b.prototype.authorize=function(a,b,c){return void 0===c&&(c=this.user),!this.options.userAuthorize||this.options.userAuthorize.call(this.options,a,b,c)},b.prototype.updatePermissionsField=function(a,b,c){var d;return b=$(b).show(),d=b.find("input").removeAttr("disabled"),this.authorize("admin",c)||b.hide(),this.authorize(a,c||{},null)?d.attr("checked","checked"):d.removeAttr("checked")},b.prototype.updateAnnotationPermissions=function(a,b,c){var d;return c.permissions||(c.permissions=$.extend(!0,{},this.options.permissions)),d=a+"-permissions",$(b).find("input").is(":checked")?c.permissions[a]=[]:c.permissions[a]=[this.options.userId(this.user)]},b.prototype.updateViewer=function(a,b,c){var d,e;if(a=$(a),e=this.options.userString(b.user),b.user&&e&&"string"==typeof e?(d=Annotator.Util.escape(this.options.userString(b.user)),a.html(d).addClass("annotator-user")):a.remove(),c&&(this.authorize("update",b)||c.hideEdit(),!this.authorize("delete",b)))return c.hideDelete()},b.prototype._setAuthFromToken=function(a){return this.setUser(a.userId)},b}(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};Annotator.Plugin.AnnotateItPermissions=function(a){function b(){return this._setAuthFromToken=__bind(this._setAuthFromToken,this),this.updateAnnotationPermissions=__bind(this.updateAnnotationPermissions,this),this.updatePermissionsField=__bind(this.updatePermissionsField,this),this.addFieldsToAnnotation=__bind(this.addFieldsToAnnotation,this),b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,groups:{world:"group:__world__",authenticated:"group:__authenticated__",consumer:"group:__consumer__"},userId:function(a){return a.userId},userString:function(a){return a.userId},userAuthorize:function(a,b,c){var d,e,f,g,h,i;return e=b.permissions||{},d=e[a]||[],f=this.groups.world,__indexOf.call(d,f)>=0||null!=c&&null!=c.userId&&null!=c.consumerKey&&(c.userId===b.user&&c.consumerKey===b.consumer||(g=this.groups.authenticated,__indexOf.call(d,g)>=0||(c.consumerKey===b.consumer&&(h=this.groups.consumer,__indexOf.call(d,h)>=0)||(c.consumerKey===b.consumer&&(i=c.userId,__indexOf.call(d,i)>=0)||!(c.consumerKey!==b.consumer||!c.admin)))))},permissions:{read:["group:__world__"],update:[],delete:[],admin:[]}},b.prototype.addFieldsToAnnotation=function(a){if(a&&(a.permissions=this.options.permissions,this.user))return a.user=this.user.userId,a.consumer=this.user.consumerKey},b.prototype.updatePermissionsField=function(a,b,c){var d;return b=$(b).show(),d=b.find("input").removeAttr("disabled"),this.authorize("admin",c)||b.hide(),this.user&&this.authorize(a,c||{},{userId:"__nonexistentuser__",consumerKey:this.user.consumerKey})?d.attr("checked","checked"):d.removeAttr("checked")},b.prototype.updateAnnotationPermissions=function(a,b,c){var d;return c.permissions||(c.permissions=this.options.permissions),d=a+"-permissions",$(b).find("input").is(":checked")?c.permissions[a]=["read"===a?this.options.groups.world:this.options.groups.consumer]:c.permissions[a]=[]},b.prototype._setAuthFromToken=function(a){return this.setUser(a)},b}(Annotator.Plugin.Permissions);var base64Decode,base64UrlDecode,createDateFromISO8601,parseToken,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};createDateFromISO8601=function(a){var b,c,d,e,f,g;return e="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",b=a.match(new RegExp(e)),d=0,c=new Date(b[1],0,1),b[3]&&c.setMonth(b[3]-1),b[5]&&c.setDate(b[5]),b[7]&&c.setHours(b[7]),b[8]&&c.setMinutes(b[8]),b[10]&&c.setSeconds(b[10]),b[12]&&c.setMilliseconds(1e3*Number("0."+b[12])),b[14]&&(d=60*Number(b[16])+Number(b[17]),d*=null!=(g="-"===b[15])?g:{1:-1}),d-=c.getTimezoneOffset(),f=Number(c)+60*d*1e3,c.setTime(Number(f)),c},base64Decode=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if("undefined"!=typeof atob&&null!==atob)return atob(a);if(c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",j=0,b=0,e="",n=[],!a)return a;for(a+="";j<a.length;)f=c.indexOf(a.charAt(j++)),g=c.indexOf(a.charAt(j++)),h=c.indexOf(a.charAt(j++)),i=c.indexOf(a.charAt(j++)),d=f<<18|g<<12|h<<6|i,k=d>>16&255,l=d>>8&255,m=255&d,64===h?n[b++]=String.fromCharCode(k):64===i?n[b++]=String.fromCharCode(k,l):n[b++]=String.fromCharCode(k,l,m);return n.join("")},base64UrlDecode=function(a){var b,c,d,e;if(c=a.length%4,0!==c)for(b=d=0,e=4-c;0<=e?d<e:d>e;b=0<=e?++d:--d)a+="=";return a=a.replace(/-/g,"+"),a=a.replace(/_/g,"/"),base64Decode(a)},parseToken=function(a){var b,c,d,e;return e=a.split("."),b=e[0],c=e[1],d=e[2],JSON.parse(base64UrlDecode(c))},Annotator.Plugin.Auth=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments),this.waitingForToken=[],this.options.token?this.setToken(this.options.token):this.requestToken()}return __extends(b,a),b.prototype.options={token:null,tokenUrl:"/auth/token",autoFetch:!0},b.prototype.requestToken=function(){return this.requestInProgress=!0,$.ajax({url:this.options.tokenUrl,dataType:"text",xhrFields:{withCredentials:!0}}).done(function(a){return function(b,c,d){return a.setToken(b)}}(this)).fail(function(a){return function(a,b,c){var d;return d=Annotator._t("Couldn't get auth token:"),console.error(""+d+" "+c,a),Annotator.showNotification(""+d+" "+a.responseText,Annotator.Notification.ERROR)}}(this)).always(function(a){return function(){return a.requestInProgress=!1}}(this))},b.prototype.setToken=function(a){var b;if(this.token=a,this._unsafeToken=parseToken(a),this.haveValidToken()){for(this.options.autoFetch&&(this.refreshTimeout=setTimeout(function(a){return function(){return a.requestToken()}}(this),1e3*(this.timeToExpiry()-2))),this.updateHeaders(),b=[];this.waitingForToken.length>0;)b.push(this.waitingForToken.pop()(this._unsafeToken));return b}if(console.warn(Annotator._t("Didn't get a valid token.")),this.options.autoFetch)return console.warn(Annotator._t("Getting a new token in 10s.")),setTimeout(function(a){return function(){return a.requestToken()}}(this),1e4)},b.prototype.haveValidToken=function(){var a;return a=this._unsafeToken&&this._unsafeToken.issuedAt&&this._unsafeToken.ttl&&this._unsafeToken.consumerKey,!!(a&&this.timeToExpiry()>0)},b.prototype.timeToExpiry=function(){var a,b,c,d;return c=(new Date).getTime()/1e3,b=createDateFromISO8601(this._unsafeToken.issuedAt).getTime()/1e3,a=b+this._unsafeToken.ttl,d=a-c,d>0?d:0},b.prototype.updateHeaders=function(){var a;return a=this.element.data("annotator:headers"),this.element.data("annotator:headers",$.extend(a,{"x-annotator-auth-token":this.token}))},b.prototype.withToken=function(a){if(null!=a)return this.haveValidToken()?a(this._unsafeToken):(this.waitingForToken.push(a),this.requestInProgress?void 0:this.requestToken())},b}(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Tags=function(a){function b(){return this.setAnnotationTags=__bind(this.setAnnotationTags,this),this.updateField=__bind(this.updateField,this),b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.options={parseTags:function(a){var b;return a=$.trim(a),b=[],a&&(b=a.split(/\s+/)),b},stringifyTags:function(a){return a.join(" ")}},b.prototype.field=null,b.prototype.input=null,b.prototype.pluginInit=function(){if(Annotator.supported())return this.field=this.annotator.editor.addField({label:Annotator._t("Add some tags here")+"…",load:this.updateField,submit:this.setAnnotationTags}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter&&this.annotator.plugins.Filter.addFilter({label:Annotator._t("Tag"),property:"tags",isFiltered:Annotator.Plugin.Tags.filterCallback}),this.input=$(this.field).find(":input")},b.prototype.parseTags=function(a){return this.options.parseTags(a)},b.prototype.stringifyTags=function(a){return this.options.stringifyTags(a)},b.prototype.updateField=function(a,b){var c;return c="",b.tags&&(c=this.stringifyTags(b.tags)),this.input.val(c)},b.prototype.setAnnotationTags=function(a,b){return b.tags=this.parseTags(this.input.val())},b.prototype.updateViewer=function(a,b){return a=$(a),b.tags&&$.isArray(b.tags)&&b.tags.length?a.addClass("annotator-tags").html(function(){var a;return a=$.map(b.tags,function(a){return'<span class="annotator-tag">'+Annotator.Util.escape(a)+"</span>"}).join(" ")}):a.remove()},b}(Annotator.Plugin),Annotator.Plugin.Tags.filterCallback=function(a,b){var c,d,e,f,g,h,i,j;if(null==b&&(b=[]),e=0,d=[],a)for(d=a.split(/\s+/g),g=0,i=d.length;g<i;g++)if(c=d[g],b.length)for(h=0,j=b.length;h<j;h++)f=b[h],f.indexOf(c)!==-1&&(e+=1);return e===d.length};var __hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Unsupported=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.options={message:Annotator._t("Sorry your current browser does not support the Annotator")},b.prototype.pluginInit=function(){if(!Annotator.supported())return $(function(a){return function(){if(Annotator.showNotification(a.options.message),void 0===window.XMLHttpRequest&&void 0!==ActiveXObject)return $("html").addClass("ie6")}}(this))},b}(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Filter=function(a){function b(a,c){this._onPreviousClick=__bind(this._onPreviousClick,this),this._onNextClick=__bind(this._onNextClick,this),this._onFilterKeyup=__bind(this._onFilterKeyup,this),this._onFilterBlur=__bind(this._onFilterBlur,this),this._onFilterFocus=__bind(this._onFilterFocus,this),this.updateHighlights=__bind(this.updateHighlights,this);var d;a=$(this.html.element).appendTo((null!=c?c.appendTo:void 0)||this.options.appendTo),b.__super__.constructor.call(this,a,c),(d=this.options).filters||(d.filters=[]),this.filter=$(this.html.filter),this.filters=[],this.current=0}return __extends(b,a),b.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"},b.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}},b.prototype.html={element:'<div class="annotator-filter">\n  <strong>'+Annotator._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n  <button class="annotator-filter-previous">'+Annotator._t("Previous")+'</button>\n<button class="annotator-filter-next">'+Annotator._t("Next")+"</button>\n</span>\n<strong>"+Annotator._t("Filter by:")+"</strong>\n</div>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+Annotator._t("Clear")+"</button>\n</span>"},b.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:!0,isFiltered:function(a,b){var c,d,e,f;if(!a||!b)return!1;for(f=a.split(/\s+/),d=0,e=f.length;d<e;d++)if(c=f[d],b.indexOf(c)===-1)return!1;return!0}},b.prototype.pluginInit=function(){var a,b,c,d;for(d=this.options.filters,b=0,c=d.length;b<c;b++)a=d[b],this.addFilter(a);if(this.updateHighlights(),this._setupListeners()._insertSpacer(),this.options.addAnnotationFilter===!0)return this.addFilter({label:Annotator._t("Annotation"),property:"text"})},b.prototype.destroy=function(){var a,c;return b.__super__.destroy.apply(this,arguments),c=$("html"),a=parseInt(c.css("padding-top"),10)||0,c.css("padding-top",a-this.element.outerHeight()),this.element.remove()},b.prototype._insertSpacer=function(){var a,b;return b=$("html"),a=parseInt(b.css("padding-top"),10)||0,b.css("padding-top",a+this.element.outerHeight()),this},b.prototype._setupListeners=function(){var a,b,c,d;for(b=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"],c=0,d=b.length;c<d;c++)a=b[c],this.annotator.subscribe(a,this.updateHighlights);return this},b.prototype.addFilter=function(a){var b,c;return c=$.extend({label:"",property:"",isFiltered:this.options.isFiltered},a),function(){var a,d,e,f;for(e=this.filters,f=[],a=0,d=e.length;a<d;a++)b=e[a],b.property===c.property&&f.push(b);return f}.call(this).length||(c.id="annotator-filter-"+c.property,c.annotations=[],c.element=this.filter.clone().appendTo(this.element),c.element.find("label").html(c.label).attr("for",c.id),c.element.find("input").attr({id:c.id,placeholder:Annotator._t("Filter by ")+c.label+"…"}),c.element.find("button").hide(),c.element.data("filter",c),this.filters.push(c)),this},b.prototype.updateFilter=function(a){var b,c,d,e,f,g,h;if(a.annotations=[],this.updateHighlights(),this.resetHighlights(),d=$.trim(a.element.find("input").val())){for(c=this.highlights.map(function(){return $(this).data("annotation")}),h=$.makeArray(c),f=0,g=h.length;f<g;f++)b=h[f],e=b[a.property],a.isFiltered(d,e)&&a.annotations.push(b);return this.filterHighlights()}},b.prototype.updateHighlights=function(){return this.highlights=this.annotator.element.find(".annotator-hl:visible"),this.filtered=this.highlights.not(this.classes.hl.hide)},b.prototype.filterHighlights=function(){var a,b,c,d,e,f,g,h,i,j;for(a=$.grep(this.filters,function(a){return!!a.annotations.length}),d=(null!=(j=a[0])?j.annotations:void 0)||[],a.length>1&&(c=[],$.each(a,function(){return $.merge(c,this.annotations)}),g=[],d=[],$.each(c,function(){return $.inArray(this,g)===-1?g.push(this):d.push(this)})),e=this.highlights,f=h=0,i=d.length;h<i;f=++h)b=d[f],e=e.not(b.highlights);return e.addClass(this.classes.hl.hide),this.filtered=this.highlights.not(this.classes.hl.hide),this},b.prototype.resetHighlights=function(){return this.highlights.removeClass(this.classes.hl.hide),this.filtered=this.highlights,this},b.prototype._onFilterFocus=function(a){var b;return b=$(a.target),b.parent().addClass(this.classes.active),b.next("button").show()},b.prototype._onFilterBlur=function(a){var b;if(!a.target.value)return b=$(a.target),b.parent().removeClass(this.classes.active),b.next("button").hide()},b.prototype._onFilterKeyup=function(a){var b;if(b=$(a.target).parent().data("filter"))return this.updateFilter(b)},b.prototype._findNextHighlight=function(a){var b,c,d,e,f,g,h,i;return this.highlights.length?(g=a?0:-1,
i=a?-1:0,h=a?"lt":"gt",b=this.highlights.not("."+this.classes.hl.hide),d=b.filter("."+this.classes.hl.active),d.length||(d=b.eq(g)),c=d.data("annotation"),e=b.index(d[0]),f=b.filter(":"+h+"("+e+")").not(c.highlights).eq(i),f.length||(f=b.eq(i)),this._scrollToHighlight(f.data("annotation").highlights)):this},b.prototype._onNextClick=function(a){return this._findNextHighlight()},b.prototype._onPreviousClick=function(a){return this._findNextHighlight(!0)},b.prototype._scrollToHighlight=function(a){return a=$(a),this.highlights.removeClass(this.classes.hl.active),a.addClass(this.classes.hl.active),$("html, body").animate({scrollTop:a.offset().top-(this.element.height()+20)},150)},b.prototype._onClearClick=function(a){return $(a.target).prev("input").val("").keyup().blur()},b}(Annotator.Plugin);